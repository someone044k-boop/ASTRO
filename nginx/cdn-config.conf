# CDN Configuration for Static Resources
# Онлайн школа навчання - CDN Integration

# This configuration is designed to work with popular CDN providers:
# - Cloudflare
# - AWS CloudFront
# - Fastly
# - Akamai

# ===========================================
# CDN HEADERS CONFIGURATION
# ===========================================

# Map for CDN cache control
map $uri $cdn_cache_control {
    default                          "public, max-age=86400";
    ~*\.(js|css)$                    "public, max-age=31536000, immutable";
    ~*\.(png|jpg|jpeg|gif|ico|svg)$  "public, max-age=31536000, immutable";
    ~*\.(woff|woff2|ttf|eot)$        "public, max-age=31536000, immutable";
    ~*\.(webp|avif)$                 "public, max-age=31536000, immutable";
    ~*\.(mp3|mp4|webm|ogg)$          "public, max-age=2592000";
    ~*\.(pdf|doc|docx)$              "public, max-age=604800";
    ~*\.html$                        "no-cache, no-store, must-revalidate";
    ~*/api/                          "no-store";
}

# Map for CDN edge TTL (for CDN-specific headers)
map $uri $cdn_edge_ttl {
    default                          "86400";
    ~*\.(js|css)$                    "31536000";
    ~*\.(png|jpg|jpeg|gif|ico|svg)$  "31536000";
    ~*\.(woff|woff2|ttf|eot)$        "31536000";
    ~*\.(webp|avif)$                 "31536000";
    ~*\.(mp3|mp4|webm|ogg)$          "2592000";
    ~*\.html$                        "0";
    ~*/api/                          "0";
}

# ===========================================
# CLOUDFLARE SPECIFIC CONFIGURATION
# ===========================================

# Trust Cloudflare IP ranges for real IP detection
# Update these ranges periodically from: https://www.cloudflare.com/ips/
set_real_ip_from 173.245.48.0/20;
set_real_ip_from 103.21.244.0/22;
set_real_ip_from 103.22.200.0/22;
set_real_ip_from 103.31.4.0/22;
set_real_ip_from 141.101.64.0/18;
set_real_ip_from 108.162.192.0/18;
set_real_ip_from 190.93.240.0/20;
set_real_ip_from 188.114.96.0/20;
set_real_ip_from 197.234.240.0/22;
set_real_ip_from 198.41.128.0/17;
set_real_ip_from 162.158.0.0/15;
set_real_ip_from 104.16.0.0/13;
set_real_ip_from 104.24.0.0/14;
set_real_ip_from 172.64.0.0/13;
set_real_ip_from 131.0.72.0/22;

# IPv6
set_real_ip_from 2400:cb00::/32;
set_real_ip_from 2606:4700::/32;
set_real_ip_from 2803:f800::/32;
set_real_ip_from 2405:b500::/32;
set_real_ip_from 2405:8100::/32;
set_real_ip_from 2a06:98c0::/29;
set_real_ip_from 2c0f:f248::/32;

real_ip_header CF-Connecting-IP;

# ===========================================
# AWS CLOUDFRONT CONFIGURATION
# ===========================================

# For CloudFront, use X-Forwarded-For header
# Uncomment if using CloudFront instead of Cloudflare:
# real_ip_header X-Forwarded-For;

# ===========================================
# STATIC ASSETS LOCATION BLOCK
# ===========================================

# Include this in your server block for CDN-optimized static file serving
# location ~* ^/static/ {
#     # CDN cache headers
#     add_header Cache-Control $cdn_cache_control;
#     add_header CDN-Cache-Control "max-age=$cdn_edge_ttl";
#     add_header Surrogate-Control "max-age=$cdn_edge_ttl";
#     
#     # Cloudflare specific
#     add_header CF-Cache-Status "HIT";
#     
#     # CORS for CDN
#     add_header Access-Control-Allow-Origin "*";
#     add_header Access-Control-Allow-Methods "GET, OPTIONS";
#     add_header Access-Control-Max-Age "86400";
#     
#     # Vary header for proper caching
#     add_header Vary "Accept-Encoding";
#     
#     # Security headers
#     add_header X-Content-Type-Options "nosniff";
#     
#     # Compression
#     gzip_static on;
#     brotli_static on;
#     
#     # Try files
#     try_files $uri =404;
# }

# ===========================================
# CDN PURGE CONFIGURATION
# ===========================================

# Location for cache purge requests (requires nginx-cache-purge module)
# location ~ /purge(/.*) {
#     allow 127.0.0.1;
#     allow 10.0.0.0/8;
#     allow 172.16.0.0/12;
#     allow 192.168.0.0/16;
#     deny all;
#     
#     proxy_cache_purge static_cache $scheme$proxy_host$1;
# }

# ===========================================
# CDN BYPASS CONFIGURATION
# ===========================================

# Map for CDN bypass (useful for debugging)
map $http_x_cdn_bypass $cdn_bypass {
    default 0;
    "true"  1;
    "1"     1;
}

# Use in location blocks:
# proxy_cache_bypass $cdn_bypass;
# proxy_no_cache $cdn_bypass;
