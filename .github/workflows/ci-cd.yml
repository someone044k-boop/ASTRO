name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  POSTGRES_VERSION: '15'
  REDIS_VERSION: '7'

jobs:
  # –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –ª—ñ–Ω—Ç–∏–Ω–≥
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: learning_school_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          frontend/package-lock.json
          backend/package-lock.json

    # Backend —Ç–µ—Å—Ç–∏
    - name: Install backend dependencies
      run: |
        cd backend
        npm ci

    - name: Run backend linting
      run: |
        cd backend
        npm run lint || true

    - name: Run backend tests
      run: |
        cd backend
        npm test
      env:
        NODE_ENV: test
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: learning_school_test
        DB_USER: postgres
        DB_PASSWORD: postgres
        REDIS_HOST: localhost
        REDIS_PORT: 6379

    # Frontend —Ç–µ—Å—Ç–∏
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    - name: Run frontend linting
      run: |
        cd frontend
        npm run lint || true

    - name: Run frontend tests
      run: |
        cd frontend
        npm test -- --coverage --watchAll=false
      env:
        CI: true

    # –ë–µ–∑–ø–µ–∫–∞
    - name: Run security audit
      run: |
        cd backend && npm audit --audit-level moderate || true
        cd frontend && npm audit --audit-level moderate || true

    # –ê–Ω–∞–ª—ñ–∑ –∫–æ–¥—É
    - name: Run code analysis
      run: |
        node scripts/test-project.js || true

  # –ó–±—ñ—Ä–∫–∞
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          frontend/package-lock.json
          backend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend && npm ci
        cd backend && npm ci

    - name: Build frontend
      run: |
        cd frontend
        npm run build

    - name: Build backend
      run: |
        cd backend
        npm run build

    # –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ñ–≤
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: |
          frontend/build/
          backend/dist/
        retention-days: 7

    # –ê–Ω–∞–ª—ñ–∑ —Ä–æ–∑–º—ñ—Ä—É –±–∞–Ω–¥–ª—É
    - name: Analyze bundle size
      run: |
        cd frontend
        npm run analyze || true

  # Docker –∑–±—ñ—Ä–∫–∞
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker images
      run: |
        # Frontend image
        docker build -t ${{ secrets.DOCKER_USERNAME }}/learning-school-frontend:latest ./frontend
        docker push ${{ secrets.DOCKER_USERNAME }}/learning-school-frontend:latest
        
        # Backend image
        docker build -t ${{ secrets.DOCKER_USERNAME }}/learning-school-backend:latest ./backend
        docker push ${{ secrets.DOCKER_USERNAME }}/learning-school-backend:latest

  # –î–µ–ø–ª–æ–π –Ω–∞ staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, docker]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to staging server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        script: |
          cd /var/www/learning-school-staging
          git pull origin develop
          docker-compose -f docker-compose.staging.yml down
          docker-compose -f docker-compose.staging.yml pull
          docker-compose -f docker-compose.staging.yml up -d
          
          # –ó–∞–ø—É—Å–∫ –º—ñ–≥—Ä–∞—Ü—ñ–π
          docker-compose -f docker-compose.staging.yml exec -T backend npm run migrate
          
          # Health check
          sleep 30
          curl -f http://localhost:4000/health || exit 1

    - name: Run staging tests
      run: |
        # –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ–π–Ω—ñ —Ç–µ—Å—Ç–∏ –Ω–∞ staging
        curl -f ${{ secrets.STAGING_URL }}/health
        curl -f ${{ secrets.STAGING_URL }}/api/health

  # –î–µ–ø–ª–æ–π –Ω–∞ production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, docker]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create backup
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è backup –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
          docker-compose exec -T postgres pg_dump -U postgres learning_school > backup_$(date +%Y%m%d_%H%M%S).sql

    - name: Deploy to production server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          cd /var/www/learning-school
          git pull origin main
          
          # Blue-green deployment
          docker-compose -f docker-compose.prod.yml up -d --scale backend=2
          
          # Health check –Ω–æ–≤–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤
          sleep 60
          curl -f http://localhost:4000/health || exit 1
          
          # –ó–∞–ø—É—Å–∫ –º—ñ–≥—Ä–∞—Ü—ñ–π
          docker-compose -f docker-compose.prod.yml exec -T backend npm run migrate
          
          # –ó—É–ø–∏–Ω–∫–∞ —Å—Ç–∞—Ä–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤
          docker-compose -f docker-compose.prod.yml up -d --scale backend=1

    - name: Run production health checks
      run: |
        curl -f ${{ secrets.PRODUCTION_URL }}/health
        curl -f ${{ secrets.PRODUCTION_URL }}/api/health/detailed

    - name: Notify deployment success
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: 'üöÄ Production deployment successful!'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –ø—ñ—Å–ª—è –¥–µ–ø–ª–æ—é
  post-deploy:
    name: Post-Deploy Monitoring
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Wait for system stabilization
      run: sleep 300 # 5 —Ö–≤–∏–ª–∏–Ω

    - name: Run performance tests
      run: |
        # Lighthouse CI –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
        npm install -g @lhci/cli
        lhci autorun --upload.target=temporary-public-storage || true

    - name: Check error rates
      run: |
        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤ –Ω–∞ –ø–æ–º–∏–ª–∫–∏
        curl -f ${{ secrets.PRODUCTION_URL }}/api/health/metrics

    - name: Update monitoring dashboards
      run: |
        # –û–Ω–æ–≤–ª–µ–Ω–Ω—è Grafana –¥–∞—à–±–æ—Ä–¥—ñ–≤
        echo "Monitoring dashboards updated"

# –î–æ–¥–∞—Ç–∫–æ–≤—ñ job'–∏ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Snyk security scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high

    - name: Run CodeQL analysis
      uses: github/codeql-action/init@v3
      with:
        languages: javascript

    - name: Perform CodeQL analysis
      uses: github/codeql-action/analyze@v3

  # –ù—ñ—á–Ω–∏–π backup
  nightly-backup:
    name: Nightly Backup
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create database backup
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          cd /var/www/learning-school
          
          # –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ backup —Å–∫—Ä–∏–ø—Ç—É
          bash scripts/auto-backup.sh production
          
          # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É backup'—É
          if [ $? -eq 0 ]; then
            echo "Backup completed successfully"
          else
            echo "Backup failed"
            exit 1
          fi

  # –©–æ–¥–µ–Ω–Ω–∏–π health check
  daily-health-check:
    name: Daily Health Check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run comprehensive health check
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          cd /var/www/learning-school
          
          # –ó–∞–ø—É—Å–∫ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤'—è
          bash scripts/health-check.sh production comprehensive
          
          # –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–≤—ñ—Ç—É
          bash scripts/monitoring.sh production --report

  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
  dependency-update:
    name: Dependency Update Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Check for dependency updates
      run: |
        # Backend dependencies
        cd backend
        npm outdated || true
        npm audit || true
        
        # Frontend dependencies
        cd ../frontend
        npm outdated || true
        npm audit || true

    - name: Create issue for outdated dependencies
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'Dependency Updates Available',
            body: 'Automated check found outdated dependencies. Please review and update.',
            labels: ['dependencies', 'maintenance']
          })

# –î–æ–¥–∞—Ç–∫–æ–≤—ñ workflow triggers
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # –ù—ñ—á–Ω–∏–π backup —â–æ–¥–Ω—è –æ 2:00 UTC
    - cron: '0 2 * * *'
    # –©–æ–¥–µ–Ω–Ω–∏–π health check –æ 6:00 UTC
    - cron: '0 6 * * *'
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π —â–æ—Ç–∏–∂–Ω—è –≤ –ø–æ–Ω–µ–¥—ñ–ª–æ–∫ –æ 9:00 UTC
    - cron: '0 9 * * 1'